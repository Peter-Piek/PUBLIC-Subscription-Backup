{
  "properties": {
    "category": "SQLEvent",
    "displayName": "SQLEvent",
    "version": 2,
    "functionAlias": "SQLEvent",
    "query": "// KQL SQL Audit Event Parser\r\n// Last Updated Date: Jun 21,  2020\r\n// SQL Server 2016\r\n//\r\n//\r\n// Parser Notes:\r\n// This parser works against the SQL Audit events being written to Application Log of Windows Events.\r\n//\r\n// Usage Instruction: \r\n// Paste below query in log analytics, click on Save button and select as Function from drop down by specifying function name and alias (e.g. SQLEvent).\r\n// Function usually takes 10-15 minutes to activate. You can then use function alias from any other queries (e.g. SQLEvent | take 10).\r\n// References: \r\n// Using functions in Azure monitor log queries : https://docs.microsoft.com/azure/azure-monitor/log-query/functions\r\n// Tech Community Blog on KQL Functions : https://techcommunity.microsoft.com/t5/Azure-Sentinel/Using-KQL-functions-to-speed-up-analysis-in-Azure-Sentinel/ba-p/712381\r\n// Detailed Blog on Monitoring SQL Server with Azure Sentinel : https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-sql-server-with-azure-sentinel/ba-p/1502960\r\n//\r\nlet SQlData = Event\r\n| where Source contains \"MSSQL\"\r\n;\r\nlet Sqlactivity = SQlData\r\n| where RenderedDescription !has \"LGIS\" and RenderedDescription !has \"LGIF\"\r\n| parse RenderedDescription with * \"action_id:\" Action:string \r\n                                    \" \" * \r\n| parse RenderedDescription with * \"client_ip:\" ClientIP:string\r\n\" permission\" * \r\n| parse RenderedDescription with * \"session_server_principal_name:\" CurrentUser:string\r\n\" \" * \r\n| parse RenderedDescription with * \"database_name:\" DatabaseName:string\r\n\"schema_name:\" Temp:string\r\n\"object_name:\" ObjectName:string\r\n\"statement:\" Statement:string\r\n\"additional_information:\" AdditionalInfo:string\r\n\".\" *\r\n;\r\nlet FailedLogon = SQlData\r\n| where EventLevelName has \"error\"\r\n| where RenderedDescription startswith \"Login\"\r\n| parse kind=regex RenderedDescription with \"Login\" LogonResult:string\r\n                                            \"for user '\" CurrentUser:string\r\n                                            \"'. Reason:\" Reason:string \" \\\\[\" *\r\n| parse kind=regex RenderedDescription with * \"CLIENT\" * \":\" ClientIP:string\r\n                                            \"]\" *\r\n;\r\nlet dbfailedLogon = SQlData\r\n| where RenderedDescription has \" Failed to open the explicitly specified database\" \r\n| parse kind=regex RenderedDescription with \"Login\" LogonResult:string\r\n                                            \"for user '\" CurrentUser:string \r\n                                            \"'. Reason:\" Reason:string \r\n                                            \" '\" DatabaseName:string\r\n                                            \"'\" *\r\n| parse kind=regex RenderedDescription with * \"CLIENT\" * \":\" ClientIP:string \r\n                                            \"]\" *\r\n;\r\nlet successLogon = SQlData\r\n| where RenderedDescription has \"LGIS\"\r\n| parse RenderedDescription with * \"action_id:\" Action:string \r\n                                    \" \" LogonResult:string \r\n                                    \":\" Temp2:string\r\n                                    \"session_server_principal_name:\" CurrentUser:string\r\n                                    \" \" *\r\n| parse RenderedDescription with * \"client_ip:\" ClientIP:string \r\n                                    \" \" *\r\n;\r\n(union isfuzzy=true\r\nSqlactivity, FailedLogon, dbfailedLogon, successLogon )\r\n| project TimeGenerated, Computer, EventID, Action, ClientIP, LogonResult, CurrentUser, Reason, DatabaseName, ObjectName, Statement"
  },
  "id": "/subscriptions/d7425a42-e8c6-4a20-8d02-c2d534dc8a85/resourceGroups/rg-buisecops-cybermxdr-westeu/providers/Microsoft.OperationalInsights/workspaces/log-buisecops-cybermxdr-westeu/savedSearches/4b262a03-1aa1-490a-9356-23f84df25722_sqlevent",
  "name": "4b262a03-1aa1-490a-9356-23f84df25722_sqlevent",
  "type": "Microsoft.OperationalInsights/savedSearches"
}
